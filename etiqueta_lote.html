<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Etiqueta de Lote</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --primary: #1A237E;
            --bg: #F5F7F9;
            --text-dark: #2c3e50;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }
        .container { max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 20px; }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 15px;
            margin-top: 15px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }
        .btn-search { background-color: var(--primary); color: white; }
        .btn-print { background-color: var(--text-dark); color: white; margin-top: 10px; }
        .btn-bt { background-color: #e0e6ed; color: var(--text-dark); margin-bottom: 15px; }
        .btn-back { background-color: #e0e6ed; color: var(--text-dark); margin-top: 20px; display: block; text-align: center; text-decoration: none; }

        /* Estilos de la Etiqueta (4x3 pulgadas) */
        #label-wrapper {
            display: none; /* Oculto hasta que se genere */
            justify-content: center;
            margin-top: 20px;
        }

        #label-template {
            background: white;
            width: 4in;
            height: 3in;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            border: 2px dashed #ccc; /* Borde visual en pantalla */
            position: relative;
            overflow: hidden;
        }

        /* Elementos internos de la etiqueta */
        .lbl-top-row { display: flex; width: 100%; align-items: center; margin-bottom: 10px; border-bottom: 2px solid black; padding-bottom: 10px; }
        .lbl-qr { margin-right: 20px; }
        .lbl-lote-group { text-align: left; flex: 1; }
        .lbl-lote-title { font-size: 1.2rem; font-weight: bold; color: #555; }
        .lbl-lote-val { font-size: 2.5rem; font-weight: 900; line-height: 1; }
        
        .lbl-prod { font-size: 1.1rem; font-weight: bold; margin-top: 5px; }
        .lbl-spec { font-size: 1rem; font-style: italic; margin-bottom: 5px; }
        .lbl-dims { font-size: 1.2rem; font-weight: bold; border-top: 2px solid black; width: 100%; padding-top: 2px; }
        
        .lbl-stats { 
            display: flex; 
            justify-content: space-around; 
            width: 100%; 
            margin-top: auto; 
            border-top: 2px solid black; 
            padding-top: 5px;
        }
        .lbl-stat-box { display: flex; flex-direction: column; }
        .lbl-stat-val { font-size: 1.4rem; font-weight: bold; }
        .lbl-stat-lbl { font-size: 0.7rem; text-transform: uppercase; }

        @media print {
            @page { size: 4in 3in; margin: 0mm; }
            html, body { margin: 0; padding: 0; }
            body * { visibility: hidden; }
            #label-wrapper, #label-template, #label-template * { visibility: visible; }
            #label-wrapper { margin: 0; display: block; }
            #label-template {
                position: fixed;
                left: 0; top: 0;
                width: 4in; height: 3in;
                border: none; /* Sin borde al imprimir */
                display: flex;
            }
            .btn-print, .container > h2, .card, .btn-back { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <h2>üè∑Ô∏è Etiqueta de Lote</h2>
    <button class="btn-bt" onclick="conectarBluetooth()">üì° Conectar Impresora BT</button>
    
    <div class="card">
        <div id="status" style="text-align:center; color:#666; font-size:0.9rem; margin-bottom:10px;">Cargando base de datos...</div>
        <label>Ingresa el N√∫mero de Lote</label>
        <input type="text" id="loteInput" placeholder="Ej: L-2024-001">
        <button class="btn-search" onclick="generarEtiqueta()">üîç GENERAR ETIQUETA</button>
    </div>

    <div id="label-wrapper">
        <div id="label-template">
            <div class="lbl-top-row">
                <div id="qrcode" class="lbl-qr"></div>
                <div class="lbl-lote-group">
                    <div class="lbl-lote-title">LOTE:</div>
                    <div class="lbl-lote-val" id="printLote">---</div>
                </div>
            </div>
            
            <div class="lbl-prod" id="printProducto">PRODUCTO</div>
            <div class="lbl-spec" id="printEspecie">Especie</div>
            <div class="lbl-dims" id="printMedidas">0 x 0</div>

            <div class="lbl-stats">
                <div class="lbl-stat-box">
                    <span class="lbl-stat-val" id="printFardos">0</span>
                    <span class="lbl-stat-lbl">Fardos</span>
                </div>
                <div class="lbl-stat-box">
                    <span class="lbl-stat-val" id="printPiezas">0</span>
                    <span class="lbl-stat-lbl">Piezas</span>
                </div>
                <div class="lbl-stat-box">
                    <span class="lbl-stat-val" id="printM2">0.00</span>
                    <span class="lbl-stat-lbl">M2 Total</span>
                </div>
            </div>
        </div>
        <button class="btn-print" onclick="imprimirEtiqueta()">üñ®Ô∏è IMPRIMIR (Bluetooth)</button>
        <button class="btn-print" style="background-color: #2c3e50; margin-top: 10px;" onclick="window.print()">üñ®Ô∏è IMPRIMIR (PC/USB)</button>
    </div>

    <!-- <a href="menu_terminado.html" class="btn-back">‚¨Ö Volver al Men√∫</a> -->
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
    let inventario = [];
    let currentLabelData = null;
    let bluetoothDevice;
    let printCharacteristic;

    window.onload = function() {
        cargarDatos();
        document.getElementById('loteInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') generarEtiqueta();
        });
        
        // Intentar reconexi√≥n silenciosa si el navegador lo soporta (Chrome/Bluefy con permisos previos)
        if (navigator.bluetooth && navigator.bluetooth.getDevices) {
            navigator.bluetooth.getDevices().then(devices => {
                const myPrinter = devices.find(d => d.name && (d.name.includes('MTH') || d.name.includes('Printer')));
                if (myPrinter) {
                    myPrinter.gatt.connect()
                    .then(server => server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb'))
                    .then(service => service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb'))
                    .then(characteristic => {
                        printCharacteristic = characteristic;
                        bluetoothDevice = myPrinter;
                        console.log("‚úÖ Impresora reconectada autom√°ticamente");
                    })
                    .catch(e => console.log("No se pudo reconectar auto:", e));
                }
            });
        }
    };

    function cargarDatos() {
        fetch(GOOGLE_SCRIPT_URL)
        .then(res => res.json())
        .then(data => {
            inventario = data;
            document.getElementById('status').innerText = `‚úÖ Base de datos lista (${data.length} registros)`;
            document.getElementById('status').style.color = "green";
        })
        .catch(err => {
            document.getElementById('status').innerText = "‚ùå Error cargando datos";
            console.error(err);
        });
    }

    function generarEtiqueta() {
        const lote = document.getElementById('loteInput').value.trim();
        if (!lote) return alert("Ingresa un lote");

        // Filtrar datos por Lote
        // Nota: Las claves dependen de tu Google Sheet. Usamos las comunes vistas en checklist.html
        const fardosLote = inventario.filter(f => String(f['# Lote']) === String(lote));

        if (fardosLote.length === 0) {
            alert("‚ùå No se encontraron fardos para el Lote: " + lote);
            document.getElementById('label-wrapper').style.display = 'none';
            return;
        }

        // Calcular Totales
        let totalFardos = fardosLote.length;
        let totalM2 = 0;
        let totalPiezas = 0;

        // Tomar datos del primer fardo para info general
        const info = fardosLote[0];
        const producto = info['Calidad'] || info['Producto'] || '---';
        const especie = info['Especie'] || '---';
        const grosor = formatearGrosor(info['Grosor "'] || info['Grosor'] || '');
        const ancho = info['Ancho "'] || info['Ancho'] || '';
        const medidas = (grosor && ancho) ? `${grosor}" x ${ancho}"` : 'Varios';

        fardosLote.forEach(f => {
            // Sumar M2
            totalM2 += parseFloat(f['M2']) || 0;
            
            // Sumar Piezas (Intentar buscar la columna Piezas, si no existe, sumar 0)
            // En registro.html se calculan piezas, si el sheet tiene columna 'Piezas' o 'Total Piezas'
            let pzs = parseInt(f['Piezas']) || parseInt(f['Total Piezas']) || 0;
            totalPiezas += pzs;
        });
        
        // Guardar datos para impresi√≥n Bluetooth
        currentLabelData = {
            lote: lote,
            producto: producto,
            especie: especie,
            medidas: medidas,
            fardos: totalFardos,
            piezas: totalPiezas,
            m2: totalM2.toFixed(2)
        };

        // Renderizar en HTML
        document.getElementById('printLote').innerText = lote;
        document.getElementById('printProducto').innerText = producto;
        document.getElementById('printEspecie').innerText = especie;
        document.getElementById('printMedidas').innerText = medidas;
        
        document.getElementById('printFardos').innerText = totalFardos;
        document.getElementById('printPiezas').innerText = totalPiezas > 0 ? totalPiezas : "-";
        document.getElementById('printM2').innerText = totalM2.toFixed(2);

        // Generar QR
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = ""; // Limpiar anterior
        
        // El contenido del QR ser√° solo el Lote, o un JSON si prefieres
        new QRCode(qrContainer, {
            text: lote,
            width: 100,
            height: 100,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });

        document.getElementById('label-wrapper').style.display = 'flex';
    }

    function formatearGrosor(valor) {
        // Si Google Sheets convierte fracciones (ej: 3/4) en fechas, las revertimos
        if (typeof valor === 'string' && valor.includes('T') && !isNaN(Date.parse(valor))) {
            const fecha = new Date(valor);
            return `${fecha.getDate()}/${fecha.getMonth() + 1}`;
        }
        return valor;
    }

    async function imprimirEtiqueta() {
        if (!currentLabelData) return alert("Primero genera una etiqueta.");

        // 1. Conexi√≥n Bluetooth si no existe
        if (!printCharacteristic) {
            await conectarBluetooth();
            if (!printCharacteristic) {
                if(confirm("No se pudo conectar Bluetooth. ¬øImprimir PDF?")) window.print();
                return;
            }
        }

        // 2. Generar Comandos TSPL
        const d = currentLabelData;
        const encoder = new TextEncoder();
        let cmd = "";

        // Configuraci√≥n Etiqueta 4x3 pulgadas (aprox 800x600 dots a 203dpi)
        cmd += "SIZE 4,3\r\n";
        cmd += "GAP 0.12,0\r\n";
        cmd += "DIRECTION 1\r\n";
        cmd += "CLS\r\n";
        cmd += "DENSITY 8\r\n";
        
        // 1. C√≥digo QR a la izquierda
        // QRCODE x,y,ECC,cell,mode,rot,model,mask,"content"
        cmd += `QRCODE 80,150,L,10,A,0,M2,S7,"${d.lote}"\r\n`;

        // 2. LOTE a la derecha del QR, alineado a la izquierda
        cmd += `TEXT 350,60,"3",0,2,2,"LOTE:"\r\n`;

        // Usamos fuente "4" pero con multiplicador 1,1 para que sea n√≠tido.
        // Si lo quieres m√°s grande, usa 1,2 (solo crece hacia abajo)
        cmd += `TEXT 400,100,"3",0,6,6,"${d.lote}"\r\n`;

        // 3. Detalles Centrados (Producto, Especie, Medidas)
        // Ajustamos Y para que queden debajo del bloque QR/Lote
        cmd += `TEXT 400,280,"3",0,1,1,2,"${d.producto}"\r\n`;
        cmd += `TEXT 400,320,"3",0,1,1,2,"${d.especie}"\r\n`;
        cmd += `TEXT 400,360,"3",0,1,1,2,"${d.medidas}"\r\n`;

        // L√≠nea separadora
        cmd += `BAR 20,430,760,3\r\n`;

        // Estad√≠sticas (Fardos | Piezas | M2)
        // Headers
        cmd += `TEXT 130,450,"2",0,1,1,2,"FARDOS"\r\n`;
        cmd += `TEXT 400,450,"2",0,1,1,2,"PIEZAS"\r\n`;
        cmd += `TEXT 670,450,"2",0,1,1,2,"M2 TOTAL"\r\n`;
        
        // Values
        cmd += `TEXT 130,480,"3",0,2,2,"${d.fardos}"\r\n`;
        cmd += `TEXT 400,480,"3",0,2,2,"${d.piezas}"\r\n`;
        cmd += `TEXT 630,480,"3",0,2,2,"${d.m2}"\r\n`;

        cmd += "PRINT 1,1\r\n";

        // 3. Enviar a Impresora
        try {
            // Enviar en trozos (Chunks) para evitar saturar el buffer de la impresora
            const encodedData = encoder.encode(cmd);
            const CHUNK_SIZE = 20; // Reducido a 20 para estabilidad
            for (let i = 0; i < encodedData.length; i += CHUNK_SIZE) {
                await printCharacteristic.writeValue(encodedData.slice(i, i + CHUNK_SIZE));
                await new Promise(resolve => setTimeout(resolve, 80)); // Pausa aumentada
            }
            alert("‚úÖ Etiqueta de Lote enviada.");
        } catch (e) {
            console.error(e);
            alert("‚ùå Error enviando datos: " + e.message);
            printCharacteristic = null; // Resetear para reconectar la pr√≥xima vez
        }
    }

    async function conectarBluetooth() {
        const statusDiv = document.getElementById('status');
        if(statusDiv) statusDiv.innerText = "‚è≥ Buscando impresoras cercanas...";

        try {
            // Solicitar dispositivo (acepta todos para encontrar la MTH)
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] // Servicio est√°ndar de impresoras
            });
            
            const server = await bluetoothDevice.gatt.connect();
            // Intentamos obtener el servicio de impresi√≥n est√°ndar
            const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
            // Caracter√≠stica de escritura est√°ndar
            printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
            
            if(statusDiv) { 
                statusDiv.innerText = "‚úÖ Conectado: " + bluetoothDevice.name; 
                statusDiv.style.color = "green"; 
            }
            alert("¬°Conectado a " + bluetoothDevice.name + "!");
        } catch (error) {
            console.error(error);
            if(statusDiv) { 
                statusDiv.innerText = "‚ùå Error de conexi√≥n"; 
                statusDiv.style.color = "red"; 
            }
            alert("Error al conectar: " + error + "\n\nAseg√∫rate de usar Bluefy y tener el Bluetooth encendido.");
        }
    }
</script>

</body>
</html>
