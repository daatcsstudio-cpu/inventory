<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Etiqueta de Lote</title>
    <style>
        body { font-family: sans-serif; background: #F5F7F9; padding: 20px; color: #2c3e50; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; text-align: center; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-search { background: #1A237E; color: white; }
        .btn-bt { background: #e67e22; color: white; margin-bottom: 10px; }
        #preview { display: none; background: white; border: 2px dashed #ccc; padding: 20px; text-align: center; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center; color:#1A237E;">üè∑Ô∏è Resumen de Lote</h2>
    <button class="btn-bt" onclick="conectarBluetooth()">üì° Conectar Impresora BT</button>
    <div class="card">
        <label>Lote</label><input type="text" id="loteInput" placeholder="Ej: L-2024-001">
        <button class="btn-search" onclick="generar()">üîç VER RESUMEN</button>
    </div>
    <div id="preview"></div>
    <button id="btnPrint" class="btn-search" style="display:none; margin-top:10px;" onclick="imprimir()">üñ®Ô∏è IMPRIMIR</button>
</div>
<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
    let inventario=[], data={}, printCharacteristic;

    window.onload = function() {
        fetch(GOOGLE_SCRIPT_URL).then(r=>r.json()).then(d=>inventario=d);
        if(navigator.bluetooth && navigator.bluetooth.getDevices) navigator.bluetooth.getDevices().then(ds=>{if(ds.length) conectarBluetooth(true)});
    };

    function generar() {
        const l = document.getElementById('loteInput').value.trim();
        const fs = inventario.filter(f=>(f['Lote']||f['# Lote'])==l);
        if(!fs.length) return alert("No encontrado");
        let m2=0, pzs=0; fs.forEach(f=>{ m2+=parseFloat(f['M2']||0); pzs+=parseInt(f['Piezas']||f['Total Piezas']||0); });
        data = { lote: l, fardos: fs.length, piezas: pzs, m2: m2.toFixed(2), prod: fs[0]['Producto']||'' };
        const p = document.getElementById('preview'); p.style.display='block';
        p.innerHTML = `${data.lote}<br>${data.prod}<br>${data.piezas} Pzs / ${data.m2} M2`;
        document.getElementById('btnPrint').style.display = 'block';
    }

    async function conectarBluetooth(silent=false) {
        try {
            let d; if(silent && navigator.bluetooth.getDevices) { const ds = await navigator.bluetooth.getDevices(); if(ds.length) d=ds[0]; }
            if(!d && !silent) d = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] });
            if(!d) return;
            const s = await d.gatt.connect(), svc = await s.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
            printCharacteristic = await svc.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
            if(!silent) alert("Conectado");
        } catch(e){ if(!silent) alert(e); }
    }

    async function imprimir() {
        if(!printCharacteristic) { await conectarBluetooth(); if(!printCharacteristic) return; }
        const d = data;
        let cmd = `SIZE 4,3\r\nGAP 0.12,0\r\nCLS\r\nQRCODE 80,150,L,10,A,0,M2,S7,"${d.lote}"\r\nTEXT 350,60,"3",0,2,2,"LOTE:"\r\nTEXT 400,100,"3",0,6,6,"${d.lote}"\r\nTEXT 400,280,"3",0,1,1,2,"${d.prod}"\r\nBAR 20,430,760,3\r\nTEXT 130,450,"2",0,1,1,2,"FARDOS"\r\nTEXT 400,450,"2",0,1,1,2,"PIEZAS"\r\nTEXT 670,450,"2",0,1,1,2,"M2 TOTAL"\r\nTEXT 130,480,"3",0,2,2,"${d.fardos}"\r\nTEXT 400,480,"3",0,2,2,"${d.piezas}"\r\nTEXT 630,480,"3",0,2,2,"${d.m2}"\r\nPRINT 1,1\r\n`;
        const dt = new TextEncoder().encode(cmd);
        for(let i=0; i<dt.length; i+=20) { await printCharacteristic.writeValue(dt.slice(i,i+20)); await new Promise(r=>setTimeout(r,50)); }
    }
</script>
</body>
</html>
