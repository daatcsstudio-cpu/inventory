<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario - Bluefy Optimizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    
    <style>
        :root {
            --primary: #1A237E;
            --accent: #1A237E;
            --bg: #F5F7F9;
            --text-dark: #2c3e50;
            --text-gray: #95a5a6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 10px;
            color: var(--text-dark);
        }
        .container { max-width: 100%; }
        h2 { text-align: center; font-size: 1.2rem; color: var(--primary); margin: 10px 0; }
        
        .card {
            background: white;
            padding: 12px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 15px;
        }

        label { display: block; margin-top: 8px; font-weight: 700; font-size: 0.8rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; }
        input, select {
            width: 100%;
            padding: 10px;
            margin-top: 4px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #fafafa;
            color: var(--text-dark);
        }
        input:focus, select:focus {
            background-color: #fff;
            border-color: var(--primary);
            outline: none;
        }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .compact-input { padding: 8px; font-size: 0.9rem; height: 38px; }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.95rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }

        .btn-add { background-color: var(--primary); color: white; }
        .btn-export { background-color: var(--text-dark); color: white; }
        .btn-print { background-color: #fff; border: 2px solid var(--primary); color: var(--primary); }
        .btn-bt { background-color: #e0e6ed; color: var(--text-dark); margin-bottom: 10px; box-shadow: none; }

        #label-template {
            display: none;
            width: 100mm;
            border: 2px solid black;
            padding: 10px;
            text-align: center;
        }
        @media print {
            body * { visibility: hidden; }
            #label-template, #label-template * { visibility: visible; }
            #label-template { position: absolute; left: 0; top: 0; display: block; }
        }

        .row-item {
            background: #fff;
            padding: 10px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .detail-table th { background: #f8f9fa; padding: 6px; font-size: 0.75rem; text-align: left; color: var(--text-gray); text-transform: uppercase; }
        .detail-table td { padding: 6px; border-bottom: 1px solid #f0f0f0; }
        .detail-table input { margin: 0; padding: 8px; }
        .btn-small { padding: 6px 10px; margin: 0; width: auto; background: var(--primary); color: white; border-radius: 6px; font-size: 0.8rem; }
        .btn-del { background: #ff5252; color: white; width: auto; padding: 6px 10px; margin: 0; border-radius: 6px; }

        #label-template {
            display: none;
            background: white;
            box-sizing: border-box;
            width: 4in;
            height: 3in;
            padding: 5px 10px;
            flex-direction: column;
            overflow: hidden;
            align-items: center;
            text-align: center;
        }

        .slider-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            gap: 10px;
            padding-bottom: 5px;
        }
        .slider-container::-webkit-scrollbar { display: none; }
        
        .slider-page {
            min-width: 100%;
            scroll-snap-align: center;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-auto-rows: min-content;
            gap: 8px;
        }
        
        .quick-btn {
            padding: 15px 0;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .quick-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 8px rgba(26, 35, 126, 0.2); }
        .quick-btn:active { transform: scale(0.95); }

        /* DEBUG PANEL */
        .debug-panel {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.75rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .debug-panel .log-item { 
            padding: 3px 0; 
            border-bottom: 1px solid #34495e;
        }
        .debug-panel .success { color: #2ecc71; }
        .debug-panel .error { color: #e74c3c; }
        .debug-panel .warning { color: #f39c12; }
        .debug-panel .info { color: #3498db; }
    </style>
</head>
<body>

<div class="container">
    <h2>Registro de Inventario (Bluefy)</h2>
    
    <!-- PANEL DE DEBUG -->
    <div class="card">
        <h3 style="margin:0 0 10px 0; font-size: 0.9rem;">üîç Debug Bluetooth</h3>
        <div id="debugPanel" class="debug-panel"></div>
        <button onclick="clearDebug()" style="background:#95a5a6; color:white; margin-top:5px; padding:8px;">Limpiar Log</button>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <button class="btn-bt" onclick="conectarBluetooth()" style="margin-bottom:0; flex: 1;">üì° Conectar BT</button>
        <button id="btnAutoPrint" class="btn-bt" onclick="toggleAutoPrint()" style="margin-bottom:0; flex: 1; background-color: #2ecc71; color: white;">üñ®Ô∏è Auto: ON</button>
        <button class="btn-bt" onclick="imprimirTest()" style="margin-bottom:0; width: 60px; background-color: #34495e; color: white;">üõ†Ô∏è</button>
    </div>

    <div class="card">
        <div class="grid-3">
            <div>
                <label>Lote</label>
                <input type="text" id="loteId" class="compact-input" placeholder="Lote">
            </div>
            <div>
                <label>Fardo</label>
                <input type="number" id="fardoNo" class="compact-input" placeholder="#">
            </div>
            <div>
                <label>Ancho</label>
                <input type="number" id="ancho" value="5" class="compact-input">
            </div>
        </div>

        <div class="grid-3">
            <div>
                <label>Grosor</label>
                <select id="grosor" class="compact-input">
                    <option value="3/4">3/4"</option>
                    <option value="1/2">1/2"</option>
                </select>
            </div>
            <div>
                <label>Producto</label>
                <select id="producto" class="compact-input" onchange="handleProductChange()">
                    <option value="Piso Barnizado">Barnizado</option>
                    <option value="Piso Crudo">Crudo</option>
                    <option value="Tranquilla">Tranquilla</option>
                    <option value="Deck">Deck</option>
                </select>
            </div>
            <div>
                <label>Especie</label>
                <input type="text" id="especie" value="Manchiche" class="compact-input">
            </div>
        </div>

        <hr>
        
        <div style="margin-bottom: 15px;">
            <label style="color:var(--primary);">1. Selecciona Piezas (Desliza ‚Üî):</label>
            <div id="quick-piezas" class="slider-container"></div>
            
            <label style="color:var(--primary); margin-top:10px;">2. Toca Largo para AGREGAR (Desliza ‚Üî):</label>
            <div id="quick-largos" class="slider-container"></div>
        </div>

        <hr>

        <div style="background: #f0f4f8; padding: 10px; border-radius: 12px; margin-bottom: 10px;">
            <label style="margin-top:0; color: var(--primary);">AGREGAR PIEZAS (Enter para agregar)</label>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="number" id="newPiezas" class="compact-input" placeholder="Pzs" style="flex:1;">
                <span style="font-weight:bold;">x</span>
                <input type="number" id="newLargo" class="compact-input" placeholder="Largo" style="flex:1;">
                <button class="btn-small" onclick="agregarLinea()" style="width:auto; height:38px; margin:0; background: var(--primary);">‚ûï</button>
            </div>
        </div>

        <table class="detail-table">
            <thead>
                <tr>
                    <th>Piezas</th>
                    <th>Largo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tablaDetallesBody"></tbody>
        </table>
        
        <button class="btn-add" onclick="agregarFardo()">Guardar Fardo</button>
    </div>

    <div class="card">
        <h3>Lote Actual: <span id="displayLote">---</span></h3>
        <div id="listaFardos"></div>
        <button class="btn-export" onclick="exportarExcel()">EXPORTAR A EXCEL</button>
    </div>
</div>

<div id="label-template">
    <svg id="barcode"></svg>
    <div id="printLote" style="font-weight:bold; font-size: 1.1rem; margin-top: 2px;">Lote: ---</div>
    <div id="printFardoM2" style="font-weight:bold; font-size: 1rem; margin-bottom: 5px;">Fardo: --- - --- M2</div>
    <div style="width:100%; border-bottom: 2px solid black; margin-bottom: 5px;"></div>
    <div id="printProducto" style="font-weight:bold; font-size: 1rem;">Producto ---</div>
    <div id="printEspecie" style="font-size: 0.9rem;">Especie: ---</div>
    <div style="width:100%; border-bottom: 2px solid black; margin: 5px 0;"></div>
    <div style="display: flex; justify-content: space-between; flex-grow: 1; width: 100%;">
        <div style="width:48%;">
            <div class="print-col-header"><b>Piezas</b></div>
            <div id="printPiezasCol"></div>
        </div>
        <div style="width:48%;">
            <div class="print-col-header"><b>Largo</b></div>
            <div id="printLargosCol"></div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
    let fardosData = [];
    let inventarioRemoto = [];
    let currentDetalles = [];
    let bluetoothDevice;
    let printCharacteristic;
    let selectedPiezas = 1;
    let autoPrint = true;

    // ==========================================
    // SISTEMA DE DEBUG MEJORADO
    // ==========================================
    function debug(message, type = 'info') {
        const panel = document.getElementById('debugPanel');
        const timestamp = new Date().toLocaleTimeString();
        const div = document.createElement('div');
        div.className = `log-item ${type}`;
        div.innerHTML = `[${timestamp}] ${message}`;
        panel.appendChild(div);
        panel.scrollTop = panel.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function clearDebug() {
        document.getElementById('debugPanel').innerHTML = '';
    }

    function handleProductChange() {
        const anchoInput = document.getElementById('ancho');
        if(anchoInput.value === "0") anchoInput.value = "5"; 
    }

    window.onload = function() {
        debug('üöÄ Aplicaci√≥n iniciada', 'success');
        debug('üì± User Agent: ' + navigator.userAgent, 'info');
        
        if (!navigator.bluetooth) {
            debug('‚ùå Este navegador NO soporta Web Bluetooth', 'error');
            alert('‚ö†Ô∏è IMPORTANTE:\n\nEste navegador NO soporta Bluetooth.\n\nPara iPhone/iPad usa:\nüì± Bluefy Browser\n\nPara Android usa:\nüì± Chrome');
        } else {
            debug('‚úÖ Web Bluetooth API disponible', 'success');
        }

        const guardado = localStorage.getItem('inventario_fardos');
        if (guardado) {
            fardosData = JSON.parse(guardado);
            debug(`üì¶ Cargados ${fardosData.length} fardos del almacenamiento local`, 'info');
        }
        
        if(localStorage.getItem('last_lote')) document.getElementById('loteId').value = localStorage.getItem('last_lote');
        if(localStorage.getItem('last_fardo')) document.getElementById('fardoNo').value = localStorage.getItem('last_fardo');
        
        document.getElementById('newPiezas').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                if (this.value.trim() === "" && currentDetalles.length > 0) {
                    agregarFardo();
                } else {
                    document.getElementById('newLargo').focus();
                }
            }
        });

        document.getElementById('newLargo').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') agregarLinea();
        });

        renderQuickButtons();
        handleProductChange();
        cargarInventarioRemoto();
        document.getElementById('loteId').addEventListener('input', actualizarLista);
        actualizarLista();
    };

    function toggleAutoPrint() {
        autoPrint = !autoPrint;
        const btn = document.getElementById('btnAutoPrint');
        if(autoPrint) {
            btn.innerText = "üñ®Ô∏è Auto: ON";
            btn.style.backgroundColor = "#2ecc71";
            btn.style.color = "white";
            debug('‚úÖ Impresi√≥n autom√°tica ACTIVADA', 'success');
        } else {
            btn.innerText = "üñ®Ô∏è Auto: OFF";
            btn.style.backgroundColor = "#95a5a6";
            btn.style.color = "white";
            debug('‚ö†Ô∏è Impresi√≥n autom√°tica DESACTIVADA', 'warning');
        }
    }

    function cargarInventarioRemoto() {
        debug('üåê Cargando inventario remoto...', 'info');
        fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            inventarioRemoto = data;
            debug(`‚úÖ Inventario remoto cargado: ${data.length} fardos`, 'success');
            actualizarLista();
        })
        .catch(error => {
            debug('‚ùå Error cargando inventario remoto: ' + error.message, 'error');
        });
    }

    function renderQuickButtons() {
        const piezasItems = [];
        for(let i=1; i<=12; i++) {
            piezasItems.push({ label: i, value: i, active: i === selectedPiezas });
        }
        
        createSlider('quick-piezas', piezasItems, 4, (val, btn) => {
            selectedPiezas = val;
            document.getElementById('newPiezas').value = val;
            document.querySelectorAll('#quick-piezas .quick-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });

        const largosItems = [];
        for(let k=4; k<=28; k++) {
            let val = k / 4;
            largosItems.push({ label: val + "'", value: val });
        }
        
        createSlider('quick-largos', largosItems, 8, (val, btn) => {
            document.getElementById('newLargo').value = val;
            document.getElementById('newPiezas').value = selectedPiezas;
            agregarLinea(true);
            
            const originalBg = btn.style.backgroundColor;
            btn.style.backgroundColor = '#1A237E';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.style.backgroundColor = originalBg;
                btn.style.color = '';
            }, 150);
        });
    }

    function createSlider(containerId, items, itemsPerPage, onClick) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        for (let i = 0; i < items.length; i += itemsPerPage) {
            const pageItems = items.slice(i, i + itemsPerPage);
            const page = document.createElement('div');
            page.className = 'slider-page';
            
            pageItems.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'quick-btn';
                if (item.active) btn.classList.add('active');
                btn.innerText = item.label;
                btn.onclick = () => onClick(item.value, btn);
                page.appendChild(btn);
            });
            container.appendChild(page);
        }
    }

    function agregarLinea(fromQuickButton = false) {
        const pzs = document.getElementById('newPiezas').value;
        const largo = document.getElementById('newLargo').value;

        if (!pzs || !largo) {
            alert("Ingresa Piezas y Largo");
            return;
        }

        currentDetalles.push({
            piezas: parseInt(pzs),
            largo: parseFloat(largo)
        });

        document.getElementById('newPiezas').value = '';
        document.getElementById('newLargo').value = '';
        
        if (!fromQuickButton) {
            document.getElementById('newPiezas').focus();
        } else {
            document.getElementById('newPiezas').value = selectedPiezas;
        }

        renderDetalles();
    }

    function renderDetalles() {
        const tbody = document.getElementById('tablaDetallesBody');
        tbody.innerHTML = "";
        currentDetalles.forEach((d, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.piezas}</td>
                <td>${d.largo}</td>
                <td><button class="btn-del" onclick="eliminarLinea(${index})">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function eliminarLinea(index) {
        currentDetalles.splice(index, 1);
        renderDetalles();
    }

    function agregarFardo() {
        const pzsInput = document.getElementById('newPiezas');
        const largoInput = document.getElementById('newLargo');
        if (pzsInput.value && largoInput.value) {
            agregarLinea();
        }

        if (currentDetalles.length === 0) {
            alert("Debes agregar al menos una l√≠nea de detalle (Piezas/Largo)");
            return;
        }

        const producto = document.getElementById('producto').value;
        const anchoGlobal = parseFloat(document.getElementById('ancho').value) || 0;
        const grosorStr = document.getElementById('grosor').value;
        const lote = document.getElementById('loteId').value;
        const fardoNo = document.getElementById('fardoNo').value;

        if(!lote || !fardoNo) {
            alert("Por favor llena el Lote y el No. de Fardo");
            return;
        }

        if (verificarDuplicado(lote, fardoNo, producto)) {
            alert("‚ö†Ô∏è EL FARDO #" + fardoNo + " YA EXISTE (en local o en la base de datos) para este Lote y Producto.");
            return;
        }

        const parseFraction = (str) => {
            if (!str) return 0;
            if (String(str).includes('/')) {
                const parts = str.split('/');
                return parseInt(parts[0]) / parseInt(parts[1]);
            }
            return parseFloat(str);
        };
        const grosorVal = parseFraction(grosorStr);
        const unidad = (producto === 'Tranquilla') ? 'ml' : 'm2';

        const filasParaEnviar = [];
        let totalMetrosFardo = 0, totalP2Fardo = 0, totalM3Fardo = 0;

        currentDetalles.forEach(d => {
            const m2_linea = (unidad === 'm2') ? d.piezas * (d.largo * 0.3048) * (anchoGlobal * 0.0254) : 0;
            const ml_linea = d.piezas * (d.largo * 0.3048);
            
            const m2Real_linea = (unidad === 'ml') ? ml_linea * (anchoGlobal * 0.0254) : m2_linea;
            const p2_linea = m2Real_linea * 10.7639;
            const m3_linea = m2Real_linea * (grosorVal * 0.0254);

            filasParaEnviar.push({
                lote: lote,
                fardoNo: fardoNo,
                producto: producto,
                grosor: String(grosorStr).includes('/') ? "'" + grosorStr : grosorStr,
                ancho: anchoGlobal,
                especie: document.getElementById('especie').value,
                piezas: d.piezas,
                largo: d.largo,
                m2: parseFloat(m2_linea.toFixed(3)), ml: parseFloat(ml_linea.toFixed(2)),
                p2: parseFloat(p2_linea.toFixed(2)), m3: parseFloat(m3_linea.toFixed(4)),
                unidad: unidad
            });

            totalMetrosFardo += (unidad === 'ml') ? ml_linea : m2_linea;
            totalP2Fardo += p2_linea;
            totalM3Fardo += m3_linea;
        });

        const payload = {
            sheetName: "PRODUCTO TERMINADO",
            filas: filasParaEnviar
        };

        fetch(GOOGLE_SCRIPT_URL, { method: "POST", body: JSON.stringify(payload) })
            .then(res => debug('‚úÖ Fardo enviado a Google Sheets', 'success'))
            .catch(err => debug('‚ùå Error enviando a Sheets: ' + err, 'error'));

        const fardoParaHistorial = {
            lote: lote, fardoNo: fardoNo, producto: producto, grosor: grosorStr, ancho: anchoGlobal,
            especie: document.getElementById('especie').value, detalles: [...currentDetalles],
            m2: parseFloat(totalMetrosFardo.toFixed(2)),
            p2: parseFloat(totalP2Fardo.toFixed(2)),
            m3: parseFloat(totalM3Fardo.toFixed(4)),
            unidad: unidad
        };

        fardosData.push(fardoParaHistorial);
        guardarDatosLocales();
        
        currentDetalles = [];
        renderDetalles();
        
        const inputFardo = document.getElementById('fardoNo');
        const nextFardo = parseInt(inputFardo.value) + 1;
        if (!isNaN(nextFardo)) inputFardo.value = nextFardo;
        
        localStorage.setItem('last_lote', lote);
        localStorage.setItem('last_fardo', inputFardo.value);
        
        if (autoPrint) {
            imprimirBluetooth(fardosData.length - 1, true);
        }
        actualizarLista();
    }

    function guardarDatosLocales() {
        localStorage.setItem('inventario_fardos', JSON.stringify(fardosData));
    }

    function verificarDuplicado(lote, fardo, producto) {
        const enLocal = fardosData.some(f => 
            String(f.lote) === String(lote) && 
            String(f.fardoNo) === String(fardo) && 
            String(f.producto) === String(producto)
        );
        const enRemoto = inventarioRemoto.some(f => 
            String(f['# Lote']) === String(lote) && 
            String(f['# Fardo']) === String(fardo) && 
            (f['Producto'] || f['Calidad']) === producto
        );
        
        return enLocal || enRemoto;
    }

    function actualizarLista() {
        const lista = document.getElementById('listaFardos');
        const displayLote = document.getElementById('displayLote');
        const loteActual = document.getElementById('loteId').value;

        lista.innerHTML = "";
        
        const locales = fardosData.filter(f => String(f.lote) === String(loteActual));
        const remotos = inventarioRemoto.filter(f => String(f['# Lote']) === String(loteActual));

        let totalMetros = 0;
        let count = 0;
        let unidadLote = 'm¬≤';

        if (locales.length > 0) {
            unidadLote = (locales[0].unidad === 'ml' || locales[0].producto === 'Tranquilla') ? 'ml' : 'm¬≤';
        } else if (remotos.length > 0) {
            unidadLote = (remotos[0]['Unidad'] || 'm2') === 'ml' ? 'ml' : 'm¬≤';
        }

        locales.forEach(f => { totalMetros += parseFloat(f.m2) || 0; count++; });
        remotos.forEach(f => { totalMetros += parseFloat(f['M2']) || 0; count++; });
        
        if (loteActual) {
            displayLote.innerHTML = `${loteActual} <br><small>(${count} Fardos - ${totalMetros.toFixed(2)} ${unidadLote})</small>`;
        } else {
            displayLote.innerText = "---";
        }
        
        remotos.forEach(f => {
            const unidadRemota = (f['Unidad'] || 'm2') === 'ml' ? 'ml' : 'm¬≤';
            const item = document.createElement('div');
            item.className = 'row-item';
            item.style.backgroundColor = '#f8f9fa'; 
            item.style.borderLeft = '4px solid #95a5a6';
            item.innerHTML = `
                <span>‚òÅÔ∏è Fardo: ${f['# Fardo']} (${f['M2']} ${unidadRemota})</span>
                <span style="font-size:0.8rem; color:#666;">${f['Calidad'] || ''}</span>
            `;
            lista.appendChild(item);
        });

        fardosData.forEach((f, index) => {
            if (String(f.lote) !== String(loteActual)) return;

            const totalPiezas = f.detalles.reduce((acc, d) => acc + d.piezas, 0);
            const unidadLocal = f.unidad || 'm2';
            
            const item = document.createElement('div');
            item.className = 'row-item';
            item.innerHTML = `
                <span>Fardo: ${f.fardoNo} (${totalPiezas} pzs - ${f.m2} ${unidadLocal})</span> 
                <div style="display:flex; gap:5px;">
                    <button onclick="guardarImagen(${index})" class="btn-small" style="background:#3498db; width:auto;">Img</button>
                    <button onclick="imprimirBluetooth(${index})" class="btn-small" style="background:#e67e22; width:auto;">BT</button>
                    <button onclick="editarFardo(${index})" class="btn-small" style="background:#f1c40f; width:auto; margin-left:5px; color:black;">‚úèÔ∏è</button>
                    <button onclick="eliminarFardo(${index})" class="btn-del" style="width:auto; margin-left:5px;">üóëÔ∏è</button>
                </div>`;
            lista.appendChild(item);
        });
    }

    function eliminarFardo(index) {
        if(confirm("¬øEst√°s seguro de borrar el Fardo #" + fardosData[index].fardoNo + "?")) {
            fardosData.splice(index, 1);
            guardarDatosLocales();
            actualizarLista();
        }
    }

    function editarFardo(index) {
        if(!confirm("¬øEditar este fardo? Se mover√° al formulario para que hagas cambios.")) return;

        const f = fardosData[index];
        
        document.getElementById('loteId').value = f.lote;
        document.getElementById('fardoNo').value = f.fardoNo;
        document.getElementById('producto').value = f.producto;
        document.getElementById('grosor').value = f.grosor;
        document.getElementById('ancho').value = f.ancho;
        document.getElementById('especie').value = f.especie;
        
        currentDetalles = [...f.detalles];
        renderDetalles();

        handleProductChange();
        
        fardosData.splice(index, 1);
        guardarDatosLocales();

        const remoteIndex = inventarioRemoto.findIndex(r => 
            String(r['# Lote']) === String(f.lote) && 
            String(r['# Fardo']) === String(f.fardoNo)
        );
        if (remoteIndex !== -1) {
            inventarioRemoto.splice(remoteIndex, 1);
        }

        actualizarLista();
        
        document.querySelector('.container').scrollIntoView({behavior: 'smooth'});
    }

    function prepararEtiqueta(f) {
        if (typeof JsBarcode !== 'undefined') {
            try {
                JsBarcode("#barcode", f.fardoNo, {
                    format: "CODE128",
                    displayValue: false,
                    height: 40,
                    width: 3,
                    margin: 0
                });
            } catch(e) { console.error(e); }
        }
        
        const unidad = f.unidad === 'ml' ? 'ML' : 'M2';
        document.getElementById('printLote').innerText = "Lote: " + f.lote;
        document.getElementById('printFardoM2').innerText = `Fardo: ${f.fardoNo} - ${f.m2} ${unidad}`;
        
        document.getElementById('printProducto').innerText = `${f.producto} ${f.grosor} x ${f.ancho}"`;
        document.getElementById('printEspecie').innerText = "Especie: " + f.especie;
        
        const colPiezas = document.getElementById('printPiezasCol');
        const colLargos = document.getElementById('printLargosCol');
        
        colPiezas.innerHTML = "";
        colLargos.innerHTML = "";

        f.detalles.forEach(d => {
            const pDiv = document.createElement('div');
            pDiv.className = 'print-val';
            pDiv.innerText = d.piezas;
            colPiezas.appendChild(pDiv);

            const lDiv = document.createElement('div');
            lDiv.className = 'print-val';
            lDiv.innerText = d.largo;
            colLargos.appendChild(lDiv);
        });
    }

    function guardarImagen(index) {
        const f = fardosData[index];
        prepararEtiqueta(f);
        
        const label = document.getElementById('label-template');
        
        label.style.display = 'flex';
        label.style.position = 'fixed';
        label.style.zIndex = '9999';
        label.style.top = '0';
        label.style.left = '0';
        
        html2canvas(label, { scale: 2 }).then(canvas => {
            label.style.display = 'none';
            
            canvas.toBlob(function(blob) {
                const file = new File([blob], `Fardo_${f.fardoNo}.png`, { type: "image/png" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({
                        files: [file]
                    }).catch(e => console.log("Compartir cancelado o fallido", e));
                } else {
                    const link = document.createElement('a');
                    link.download = `Fardo_${f.fardoNo}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }
            });
        });
    }

    function exportarExcel() {
        if(fardosData.length === 0) return alert("No hay datos para exportar");
        
        let flatData = [];
        fardosData.forEach(f => {
            f.detalles.forEach(d => {
                flatData.push({
                    Lote: f.lote,
                    Fardo: f.fardoNo,
                    Producto: f.producto,
                    Grosor: f.grosor,
                    Especie: f.especie,
                    Piezas: d.piezas,
                    Largo_Ft: d.largo,
                    Ancho_In: f.ancho,
                    Metros: f.m2,
                    Unidad: f.unidad
                });
            });
        });

        const worksheet = XLSX.utils.json_to_sheet(flatData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
        
        XLSX.writeFile(workbook, `Inventario_Lote_${fardosData[0].lote}.xlsx`);
    }

    // ==========================================
    // BLUETOOTH - VERSI√ìN OPTIMIZADA PARA BLUEFY
    // ==========================================
    async function conectarBluetooth() {
        debug('üîç Iniciando b√∫squeda de dispositivos Bluetooth...', 'info');
        
        try {
            // Lista de UUIDs de servicios comunes en impresoras t√©rmicas
            const servicios = [
                '000018f0-0000-1000-8000-00805f9b34fb', // TSPL Standard
                'e7810a71-73ae-499d-8c15-faa9aef0c3f2', // MPT-II / Chinas
                '49535343-fe7d-4ae5-8fa9-9fafd205e455', // Feasycom/Transparent
                '0000ff00-0000-1000-8000-00805f9b34fb', // MHT
                '0000ae00-0000-1000-8000-00805f9b34fb', // MHT Variante
                '6e400001-b5a3-f393-e0a9-e50e24dcca9e'  // Nordic UART / Varios
            ];

            debug('üìã Servicios a buscar: ' + servicios.length, 'info');

            // Solicitar dispositivo
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: servicios
            });

            debug(`‚úÖ Dispositivo seleccionado: ${device.name || 'Sin nombre'}`, 'success');
            debug(`   ID: ${device.id}`, 'info');

            // Conectar al servidor GATT
            debug('üîó Conectando al servidor GATT...', 'info');
            const server = await device.gatt.connect();
            debug('‚úÖ Servidor GATT conectado', 'success');

            // Buscar servicio y caracter√≠stica compatible
            let characteristic = null;
            let servicioEncontrado = null;

            for (const uuid of servicios) {
                try {
                    debug(`   Probando servicio: ${uuid.substring(0, 8)}...`, 'info');
                    const service = await server.getPrimaryService(uuid);
                    const characteristics = await service.getCharacteristics();
                    
                    debug(`   Encontradas ${characteristics.length} caracter√≠sticas`, 'info');
                    
                    for (const char of characteristics) {
                        const props = [];
                        if (char.properties.write) props.push('write');
                        if (char.properties.writeWithoutResponse) props.push('writeWithoutResponse');
                        if (char.properties.notify) props.push('notify');
                        
                        debug(`      Caracter√≠stica: ${char.uuid.substring(0, 8)}... [${props.join(', ')}]`, 'info');
                        
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            characteristic = char;
                            servicioEncontrado = uuid;
                            debug(`‚úÖ Caracter√≠stica de escritura encontrada!`, 'success');
                            break;
                        }
                    }
                    
                    if (characteristic) break;
                    
                } catch (e) {
                    // Silencioso para no llenar el log
                }
            }

            // FALLBACK: Si no se encontr√≥ en la lista conocida, buscar en TODOS los servicios disponibles
            if (!characteristic) {
                debug('‚ö†Ô∏è Servicios conocidos fallaron. Iniciando escaneo profundo...', 'warning');
                try {
                    const allServices = await server.getPrimaryServices();
                    debug(`   Dispositivo ofrece ${allServices.length} servicios totales`, 'info');
                    
                    for (const service of allServices) {
                        const chars = await service.getCharacteristics();
                        for (const char of chars) {
                            if (char.properties.write || char.properties.writeWithoutResponse) {
                                characteristic = char;
                                servicioEncontrado = service.uuid;
                                debug(`‚úÖ Caracter√≠stica descubierta en escaneo: ${char.uuid}`, 'success');
                                break;
                            }
                        }
                        if (characteristic) break;
                    }
                } catch (e) {
                    debug('‚ùå Fall√≥ el escaneo profundo: ' + e.message, 'error');
                }
            }

            if (!characteristic) {
                throw new Error('No se encontr√≥ una caracter√≠stica de escritura compatible en ning√∫n servicio');
            }

            // Guardar globalmente
            printCharacteristic = characteristic;
            bluetoothDevice = device;

            debug(`üéâ CONEXI√ìN EXITOSA`, 'success');
            debug(`   Servicio usado: ${servicioEncontrado.substring(0, 8)}...`, 'info');
            debug(`   Caracter√≠stica: ${characteristic.uuid.substring(0, 8)}...`, 'info');
            
            alert(`‚úÖ CONECTADO!\n\nImpresora: ${device.name || 'Sin nombre'}\nListo para imprimir`);

        } catch (error) {
            debug(`‚ùå ERROR DE CONEXI√ìN: ${error.message}`, 'error');
            console.error('Error completo:', error);
            
            let mensaje = 'Error al conectar con la impresora:\n\n';
            
            if (error.name === 'NotFoundError') {
                mensaje += '‚Ä¢ No se seleccion√≥ ning√∫n dispositivo\n';
            } else if (error.name === 'SecurityError') {
                mensaje += '‚Ä¢ Problema de permisos de Bluetooth\n';
                mensaje += '‚Ä¢ Verifica permisos en configuraci√≥n del navegador\n';
            } else if (error.message.includes('GATT')) {
                mensaje += '‚Ä¢ La impresora rechaz√≥ la conexi√≥n\n';
                mensaje += '‚Ä¢ Intenta apagarla y encenderla de nuevo\n';
            } else {
                mensaje += error.message + '\n';
            }
            
            mensaje += '\nüí° Recomendaciones:\n';
            mensaje += '‚Ä¢ Aseg√∫rate de que la impresora est√© encendida\n';
            mensaje += '‚Ä¢ Mant√©n el dispositivo cerca (< 3 metros)\n';
            mensaje += '‚Ä¢ Verifica que Bluetooth est√© activado\n';
            mensaje += '‚Ä¢ En iOS usa Bluefy Browser';
            
            alert(mensaje);
        }
    }

    async function imprimirBluetooth(index, silent = false) {
        if (!printCharacteristic) {
            debug('‚ö†Ô∏è No hay impresora conectada', 'warning');
            if (!silent) alert('‚ö†Ô∏è Primero debes conectar la impresora\n\nPresiona el bot√≥n "Conectar BT"');
            await conectarBluetooth();
            if (!printCharacteristic) return;
        }

        const fardo = fardosData[index];
        debug(`üñ®Ô∏è Iniciando impresi√≥n del Fardo #${fardo.fardoNo}`, 'info');

        try {
            const encoder = new TextEncoder();
            const unidad = fardo.unidad || 'm2';
            const unidadDisplay = unidad === 'ml' ? 'ML' : 'M2';

            // Generar comandos TSPL
            let cmd = "";
            cmd += "SIZE 4,3\r\n";
            cmd += "GAP 0.12,0\r\n";
            cmd += "DIRECTION 1\r\n";
            cmd += "CLS\r\n";
            cmd += "DENSITY 10\r\n"; // Aumentado para mejor visibilidad

            cmd += `BARCODE 60,20,"128",60,1,0,3,3,"${fardo.fardoNo}"\r\n`;
            cmd += `TEXT 300,125,"3",0,1,1,2,"Lote: ${fardo.lote}"\r\n`;
            cmd += `TEXT 350,45,"3",0,1,1,2,"Fardo: ${fardo.fardoNo}  -  ${fardo.m2} ${unidadDisplay}"\r\n`;
            cmd += `BAR 40,155,720,2\r\n`;
            cmd += `TEXT 266,175,"3",0,1,1,2,"${fardo.producto}"\r\n`;
            cmd += `TEXT 206,210,"3",0,1,1,2,"${fardo.grosor} x ${fardo.ancho} pulg  -  ${fardo.especie}"\r\n`;
            cmd += `BAR 40,240,720,2\r\n`;
            cmd += `TEXT 60,260,"3",0,1,1,"LARGO"\r\n`;
            cmd += `TEXT 314,260,"3",0,1,1,"PIEZAS"\r\n`;
            cmd += `TEXT 650,260,"3",0,1,1,"${unidadDisplay}"\r\n`;

            let y = 290;
            if (fardo.detalles && fardo.detalles.length > 0) {
                fardo.detalles.forEach((d, idx) => {
                    if (y < 500) {
                        const metros_linea = (unidad === 'ml')
                            ? d.piezas * (d.largo * 0.3048)
                            : d.piezas * (d.largo * 0.3048) * (fardo.ancho * 0.0254);
                        
                        cmd += `TEXT 60,${y},"3",0,1,1,"${d.largo}"\r\n`;
                        cmd += `TEXT 350,${y},"3",0,1,1,"${d.piezas}"\r\n`;
                        cmd += `TEXT 650,${y},"3",0,1,1,"${metros_linea.toFixed(2)}"\r\n`;
                        y += 35;
                    }
                });
            }

            cmd += `BAR 40,510,720,2\r\n`;
            const totalPzs = fardo.detalles ? fardo.detalles.reduce((acc, d) => acc + d.piezas, 0) : 0;
            cmd += `TEXT 158,540,"3",0,1,1,"TOTAL PIEZAS: ${totalPzs}"\r\n`;
            cmd += `TEXT 532,540,"3",0,1,1,3,"TOTAL: ${fardo.m2} ${unidadDisplay}"\r\n`;
            cmd += "PRINT 1,1\r\n";

            // Enviar en chunks
            const encodedData = encoder.encode(cmd);
            const CHUNK_SIZE = 20;
            const totalChunks = Math.ceil(encodedData.length / CHUNK_SIZE);
            
            debug(`üì§ Enviando ${encodedData.length} bytes en ${totalChunks} paquetes...`, 'info');

            for (let i = 0; i < encodedData.length; i += CHUNK_SIZE) {
                const chunk = encodedData.slice(i, i + CHUNK_SIZE);
                const chunkNum = Math.floor(i / CHUNK_SIZE) + 1;
                
                try {
                    // Intentar writeWithoutResponse primero (m√°s r√°pido)
                    if (printCharacteristic.properties.writeWithoutResponse) {
                        await printCharacteristic.writeValueWithoutResponse(chunk);
                    } else {
                        await printCharacteristic.writeValue(chunk);
                    }
                    
                    if (chunkNum % 10 === 0) {
                        debug(`   Progreso: ${chunkNum}/${totalChunks} paquetes`, 'info');
                    }
                } catch (writeError) {
                    debug(`‚ùå Error en paquete ${chunkNum}: ${writeError.message}`, 'error');
                    throw writeError;
                }
                
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            debug(`‚úÖ Impresi√≥n completada (${totalChunks} paquetes enviados)`, 'success');
            if (!silent) alert(`‚úÖ Etiqueta enviada!\n\nFardo #${fardo.fardoNo}\nRevisa la impresora`);

        } catch (error) {
            debug(`‚ùå ERROR DE IMPRESI√ìN: ${error.message}`, 'error');
            console.error('Error completo:', error);
            
            // Limpiar conexi√≥n si es error de GATT
            if (error.message.includes('GATT') || error.message.includes('disconnect')) {
                printCharacteristic = null;
                bluetoothDevice = null;
                debug('üîå Conexi√≥n perdida - Reconectar necesario', 'warning');
            }
            
            if (!silent) {
                alert(`‚ùå Error al imprimir:\n\n${error.message}\n\nRevisa el log de debug para m√°s detalles.\n\nSi persiste, reconecta la impresora.`);
            }
        }
    }

    async function imprimirTest() {
        if (!printCharacteristic) {
            await conectarBluetooth();
            if (!printCharacteristic) return;
        }
        
        try {
            const encoder = new TextEncoder();
            const cmd = "SIZE 4,3\r\nCLS\r\nTEXT 50,50,\"3\",0,1,1,\"PRUEBA DE IMPRESION\"\r\nTEXT 50,100,\"3\",0,1,1,\"Si lees esto, funciona!\"\r\nPRINT 1,1\r\n";
            const data = encoder.encode(cmd);
            await printCharacteristic.writeValue(data);
            alert("‚úÖ Comando de prueba enviado");
        } catch (e) {
            alert("‚ùå Error en prueba: " + e.message);
        }
    }
</script>

</body>
</html>