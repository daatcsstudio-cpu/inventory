<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventario de Piso - Manchiche</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="formato_etiqueta_producto_terminado.js"></script>
    <style>
        :root {
            --primary: #1A237E; /* Azul Marino Ticket */
            --accent: #1A237E;  /* Unificamos acento al azul */
            --bg: #F5F7F9;      /* Fondo Gris Claro */
            --text-dark: #2c3e50;
            --text-gray: #95a5a6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 10px; /* Padding reducido para ganar espacio */
            color: var(--text-dark);
        }
        .container { max-width: 100%; }
        h2 { text-align: center; font-size: 1.2rem; color: var(--primary); margin: 10px 0; }
        
        .card {
            background: white;
            padding: 12px; /* Compacto */
            border-radius: 16px; /* Bordes redondeados estilo Ticket */
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Sombra sutil */
            margin-bottom: 15px;
        }

        label { display: block; margin-top: 8px; font-weight: 700; font-size: 0.8rem; color: var(--text-gray); text-transform: uppercase; letter-spacing: 0.5px; }
        input, select {
            width: 100%;
            padding: 10px; /* Ligeramente m√°s compacto */
            margin-top: 4px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            background-color: #fafafa;
            color: var(--text-dark);
        }
        input:focus, select:focus {
            background-color: #fff;
            border-color: var(--primary);
            outline: none;
        }

        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .compact-input { padding: 8px; font-size: 0.9rem; height: 38px; }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.95rem;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.8; }

        .btn-add { background-color: var(--primary); color: white; }
        .btn-export { background-color: var(--text-dark); color: white; }
        .btn-print { background-color: #fff; border: 2px solid var(--primary); color: var(--primary); }
        .btn-bt { background-color: #e0e6ed; color: var(--text-dark); margin-bottom: 10px; box-shadow: none; }

        /* Estilo de la Etiqueta para Impresi√≥n */
        #label-template {
            display: none;
            width: 100mm;
            border: 2px solid black;
            padding: 10px;
            text-align: center;
        }
        @media print {
            body * { visibility: hidden; }
            #label-template, #label-template * { visibility: visible; }
            #label-template { position: absolute; left: 0; top: 0; display: block; }
        }

        .row-item {
            background: #fff;
            padding: 10px;
            margin-top: 8px;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            border: 1px solid #eee;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        
        /* Estilos para la tabla de detalles */
        .detail-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .detail-table th { background: #f8f9fa; padding: 6px; font-size: 0.75rem; text-align: left; color: var(--text-gray); text-transform: uppercase; }
        .detail-table td { padding: 6px; border-bottom: 1px solid #f0f0f0; }
        .detail-table input { margin: 0; padding: 8px; }
        .btn-small { padding: 6px 10px; margin: 0; width: auto; background: var(--primary); color: white; border-radius: 6px; font-size: 0.8rem; }
        .btn-del { background: #ff5252; color: white; width: auto; padding: 6px 10px; margin: 0; border-radius: 6px; }

        /* Estilo de la Etiqueta para Impresi√≥n (4x3 pulgadas) */
        #label-template {
            display: none;
            background: white;
            box-sizing: border-box;
            width: 4in;
            height: 3in;
            padding: 5px 10px;
            flex-direction: column;
            overflow: hidden;
            align-items: center;
            text-align: center;
        }
        @media print {
            @page { size: 4in 3in; margin: 0mm; }
            html, body { margin: 0; padding: 0; }
            body * { visibility: hidden; }
            #label-template, #label-template * { visibility: visible; }
            #label-template {
                position: fixed;
                left: 0; top: 0;
                width: 4in; height: 3in;
                display: flex; flex-direction: column;
                padding: 5px 10px;
                border: none;
                overflow: hidden; /* Evita que el contenido salte a una segunda p√°gina */
                align-items: center;
                text-align: center;
            }
            /* Ajustes de fuente para etiqueta peque√±a */
            #printFardo, #printM2 { font-size: 1.4rem !important; }
            #printProducto { font-size: 1.1rem !important; }
            .print-col-header { border-bottom: 1px solid #000; margin-bottom: 2px; font-size: 0.9rem; }
            .print-val { font-size: 1rem; }
        }

        /* Estilos para Slider Horizontal (P√°ginas) */
        .slider-container {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            gap: 10px;
            padding-bottom: 5px;
        }
        .slider-container::-webkit-scrollbar { display: none; }
        
        .slider-page {
            min-width: 100%;
            scroll-snap-align: center;
            display: grid;
            grid-template-columns: repeat(4, 1fr); /* 4 botones por fila */
            grid-auto-rows: min-content;
            gap: 8px;
        }
        
        .quick-btn {
            padding: 15px 0;
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none; /* Evita zoom/selecci√≥n al tocar r√°pido */
            touch-action: manipulation;
        }
        .quick-btn.active { background-color: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 8px rgba(26, 35, 126, 0.2); }
        .quick-btn:active { transform: scale(0.95); }
    </style>
</head>
<body>

<div class="container">
    <h2>Registro de Inventario</h2>
    
    <button class="btn-bt" onclick="conectarBluetooth()">üì° Conectar Impresora BT</button>

    <div class="card">
        <div class="grid-3">
            <div>
                <label>Lote</label>
                <input type="text" id="loteId" class="compact-input" placeholder="Lote">
            </div>
            <div>
                <label>Fardo</label>
                <input type="number" id="fardoNo" class="compact-input" placeholder="#">
            </div>
            <div>
                <label>Ancho</label>
                <input type="number" id="ancho" value="5" class="compact-input">
            </div>
        </div>

        <div class="grid-3">
            <div>
                <label>Grosor</label>
                <select id="grosor" class="compact-input">
                    <option value="3/4">3/4"</option>
                    <option value="1/2">1/2"</option>
                </select>
            </div>
            <div>
                <label>Producto</label>
                <select id="producto" class="compact-input" onchange="handleProductChange()">
                    <option value="Piso Barnizado">Barnizado</option>
                    <option value="Piso Crudo">Crudo</option>
                    <option value="Tranquilla">Tranquilla</option>
                </select>
            </div>
            <div>
                <label>Especie</label>
                <input type="text" id="especie" value="Manchiche" class="compact-input">
            </div>
        </div>

        <hr>
        
        <!-- PANEL T√ÅCTIL (Sin Teclado) -->
        <div style="margin-bottom: 15px;">
            <label style="color:var(--primary);">1. Selecciona Piezas (Desliza ‚Üî):</label>
            <div id="quick-piezas" class="slider-container"></div>
            
            <label style="color:var(--primary); margin-top:10px;">2. Toca Largo para AGREGAR (Desliza ‚Üî):</label>
            <div id="quick-largos" class="slider-container"></div>
        </div>

        <hr>

        <!-- Entrada R√°pida -->
        <div style="background: #f0f4f8; padding: 10px; border-radius: 12px; margin-bottom: 10px;">
            <label style="margin-top:0; color: var(--primary);">AGREGAR PIEZAS (Enter para agregar)</label>
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="number" id="newPiezas" class="compact-input" placeholder="Pzs" style="flex:1;">
                <span style="font-weight:bold;">x</span>
                <input type="number" id="newLargo" class="compact-input" placeholder="Largo" style="flex:1;">
                <button class="btn-small" onclick="agregarLinea()" style="width:auto; height:38px; margin:0; background: var(--primary);">‚ûï</button>
            </div>
        </div>

        <table class="detail-table">
            <thead>
                <tr>
                    <th>Piezas</th>
                    <th>Largo</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="tablaDetallesBody">
                <!-- Filas din√°micas -->
            </tbody>
        </table>
        
        <button class="btn-add" onclick="agregarFardo()">Guardar Fardo</button>
    </div>

    <div class="card">
        <h3>Lote Actual: <span id="displayLote">---</span></h3>
        <div id="listaFardos"></div>
        <button class="btn-export" onclick="exportarExcel()">EXPORTAR A EXCEL</button>
    </div>
</div>

<div id="label-template">
    <!-- C√≥digo de Barras -->
    <svg id="barcode"></svg>
    
    <div id="printLote" style="font-weight:bold; font-size: 1.1rem; margin-top: 2px;">Lote: ---</div>
    <div id="printFardoM2" style="font-weight:bold; font-size: 1rem; margin-bottom: 5px;">Fardo: --- - --- M2</div>
    
    <div style="width:100%; border-bottom: 2px solid black; margin-bottom: 5px;"></div>
    
    <div id="printProducto" style="font-weight:bold; font-size: 1rem;">Producto ---</div>
    <div id="printEspecie" style="font-size: 0.9rem;">Especie: ---</div>

    <div style="width:100%; border-bottom: 2px solid black; margin: 5px 0;"></div>

    <div style="display: flex; justify-content: space-between; flex-grow: 1; width: 100%;">
        <div style="width:48%;">
            <div class="print-col-header"><b>Piezas</b></div>
            <div id="printPiezasCol"></div>
        </div>
        <div style="width:48%;">
            <div class="print-col-header"><b>Largo</b></div>
            <div id="printLargosCol"></div>
        </div>
    </div>
</div>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
    let fardosData = [];
    let inventarioRemoto = [];
    let currentDetalles = [];
    let bluetoothDevice;
    let printCharacteristic;
    let selectedPiezas = 1; // Valor por defecto para botones r√°pidos

    function handleProductChange() {
        // El ancho ahora es necesario para todos los productos
        const anchoInput = document.getElementById('ancho');
        if(anchoInput.value === "0") anchoInput.value = "5"; 
    }

    // Cargar datos guardados al iniciar la p√°gina
    window.onload = function() {
        const guardado = localStorage.getItem('inventario_fardos');
        if (guardado) {
            fardosData = JSON.parse(guardado);
        }
        // Recuperar √∫ltimo lote y n√∫mero de fardo
        if(localStorage.getItem('last_lote')) document.getElementById('loteId').value = localStorage.getItem('last_lote');
        if(localStorage.getItem('last_fardo')) document.getElementById('fardoNo').value = localStorage.getItem('last_fardo');
        
        // Eventos para entrada r√°pida con Enter
        document.getElementById('newPiezas').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') document.getElementById('newLargo').focus();
        });

        document.getElementById('newLargo').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') agregarLinea();
        });

        renderQuickButtons();
        handleProductChange();
        
        // Cargar base de datos remota y configurar listener de Lote
        cargarInventarioRemoto();
        document.getElementById('loteId').addEventListener('input', actualizarLista);
        
        // Render inicial
        actualizarLista();
    };

    function cargarInventarioRemoto() {
        fetch(GOOGLE_SCRIPT_URL)
        .then(response => response.json())
        .then(data => {
            inventarioRemoto = data;
            console.log("Inventario remoto cargado: " + data.length + " fardos.");
            actualizarLista(); // Actualizar lista por si ya hay un lote escrito
        })
        .catch(error => {
            console.error("Error cargando inventario remoto:", error);
        });
    }

    function renderQuickButtons() {
        // Piezas: 1 a 12 (P√°ginas de 4)
        const piezasItems = [];
        for(let i=1; i<=12; i++) {
            piezasItems.push({ label: i, value: i, active: i === selectedPiezas });
        }
        
        createSlider('quick-piezas', piezasItems, 4, (val, btn) => {
            selectedPiezas = val;
            document.getElementById('newPiezas').value = val;
            // Actualizar visualmente
            document.querySelectorAll('#quick-piezas .quick-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });

        // Largos: 1 a 7 con incrementos de 0.25 (P√°ginas de 8)
        const largosItems = [];
        for(let k=4; k<=28; k++) {
            let val = k / 4;
            largosItems.push({ label: val + "'", value: val });
        }
        
        createSlider('quick-largos', largosItems, 8, (val, btn) => {
            document.getElementById('newLargo').value = val;
            document.getElementById('newPiezas').value = selectedPiezas;
            agregarLinea(true);
            
            // Feedback visual al tocar
            const originalBg = btn.style.backgroundColor;
            btn.style.backgroundColor = '#1A237E';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.style.backgroundColor = originalBg;
                btn.style.color = '';
            }, 150);
        });
    }

    function createSlider(containerId, items, itemsPerPage, onClick) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        for (let i = 0; i < items.length; i += itemsPerPage) {
            const pageItems = items.slice(i, i + itemsPerPage);
            const page = document.createElement('div');
            page.className = 'slider-page';
            
            pageItems.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'quick-btn';
                if (item.active) btn.classList.add('active');
                btn.innerText = item.label;
                btn.onclick = () => onClick(item.value, btn);
                page.appendChild(btn);
            });
            container.appendChild(page);
        }
    }

    function agregarLinea(fromQuickButton = false) {
        const pzs = document.getElementById('newPiezas').value;
        const largo = document.getElementById('newLargo').value;

        if (!pzs || !largo) {
            alert("Ingresa Piezas y Largo");
            return;
        }

        currentDetalles.push({
            piezas: parseInt(pzs),
            largo: parseFloat(largo)
        });

        // Limpiar inputs
        document.getElementById('newPiezas').value = '';
        document.getElementById('newLargo').value = '';
        
        // Solo poner foco (abrir teclado) si NO viene de los botones r√°pidos
        if (!fromQuickButton) {
            document.getElementById('newPiezas').focus();
        } else {
            // Si viene de bot√≥n r√°pido, restaurar el valor visual de piezas seleccionado
            document.getElementById('newPiezas').value = selectedPiezas;
        }

        renderDetalles();
    }

    function renderDetalles() {
        const tbody = document.getElementById('tablaDetallesBody');
        tbody.innerHTML = "";
        currentDetalles.forEach((d, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${d.piezas}</td>
                <td>${d.largo}</td>
                <td><button class="btn-del" onclick="eliminarLinea(${index})">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function eliminarLinea(index) {
        currentDetalles.splice(index, 1);
        renderDetalles();
    }

    function agregarFardo() {
        try {
            // 1. Auto-agregar l√≠nea pendiente si el usuario olvid√≥ darle al "+"
            const pzsInput = document.getElementById('newPiezas');
            const largoInput = document.getElementById('newLargo');
            if (pzsInput.value && largoInput.value) {
                agregarLinea();
            }

            if (currentDetalles.length === 0) {
                alert("Debes agregar al menos una l√≠nea de detalle (Piezas/Largo)");
                return;
            }

            const producto = document.getElementById('producto').value;
            const anchoGlobal = parseFloat(document.getElementById('ancho').value) || 0;

            // Calcular M2 o ML Total
            let totalMetros = 0;
            let unidad = 'm2';

            if (producto === 'Tranquilla') {
                unidad = 'ml';
                currentDetalles.forEach(d => {
                    // Metros lineales: Piezas * (Largo en ft a m)
                    totalMetros += d.piezas * (d.largo * 0.3048);
                });
            } else {
                unidad = 'm2';
                currentDetalles.forEach(d => {
                    // Metros cuadrados: Piezas * (Largo en m) * (Ancho en m)
                    totalMetros += d.piezas * (d.largo * 0.3048) * (anchoGlobal * 0.0254);
                });
            }

            const fardo = {
                lote: document.getElementById('loteId').value,
                fardoNo: document.getElementById('fardoNo').value,
                producto: producto,
                grosor: document.getElementById('grosor').value,
                ancho: anchoGlobal,
                especie: document.getElementById('especie').value,
                detalles: [...currentDetalles], // Copia del array
                m2: totalMetros.toFixed(2), // Keep name m2 for compatibility, but value can be m2 or ml
                unidad: unidad
            };

            if(!fardo.lote || !fardo.fardoNo) {
                alert("Por favor llena el Lote y el No. de Fardo");
                return;
            }

            if (verificarDuplicado(fardo.fardoNo)) {
                alert("‚ö†Ô∏è EL FARDO #" + fardo.fardoNo + " YA EXISTE (en local o en la base de datos).");
                return;
            }

            // --- SINCRONIZACI√ìN CON GOOGLE SHEETS ---
            
            // Enviar el objeto fardo completo.
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(fardo)
            })
            .then(res => console.log("Enviado a Sheets"))
            .catch(err => console.error("Error enviando a Sheets: " + err));

            fardosData.push(fardo);
            
            // Guardar en memoria local (Protegido)
            try { guardarDatosLocales(); } catch(e) { console.error("Error guardando local", e); }
            
            // Resetear detalles
            currentDetalles = [];
            renderDetalles();
            
            // Auto-incrementar Fardo No.
            const inputFardo = document.getElementById('fardoNo');
            const nextFardo = parseInt(inputFardo.value) + 1;
            if (!isNaN(nextFardo)) inputFardo.value = nextFardo;
            
            localStorage.setItem('last_lote', document.getElementById('loteId').value);
            localStorage.setItem('last_fardo', inputFardo.value);
            
            // Intentar imprimir (protegido contra errores para no detener el flujo)
            try {
                imprimir(fardosData.length - 1); 
            } catch(e) {
                console.error("Error al imprimir:", e);
            }
        } catch (error) {
            alert("Error CR√çTICO al guardar fardo: " + error.message);
            console.error(error);
        }
    }

    function guardarDatosLocales() {
        localStorage.setItem('inventario_fardos', JSON.stringify(fardosData));
    }

    function verificarDuplicado(numero) {
        // 1. Verificar en sesi√≥n local
        const enLocal = fardosData.some(f => String(f.fardoNo) === String(numero));
        // 2. Verificar en base de datos remota
        // Nota: Las claves del JSON de Google Sheets suelen ser '# Fardo'
        const enRemoto = inventarioRemoto.some(f => String(f['# Fardo']) === String(numero));
        
        return enLocal || enRemoto;
    }

    function actualizarLista() {
        const lista = document.getElementById('listaFardos');
        const displayLote = document.getElementById('displayLote');
        const loteActual = document.getElementById('loteId').value;

        lista.innerHTML = "";
        
        // Filtrar Locales y Remotos por Lote
        const locales = fardosData.filter(f => String(f.lote) === String(loteActual));
        const remotos = inventarioRemoto.filter(f => String(f['# Lote']) === String(loteActual));

        // Calcular totales combinados
        let totalMetros = 0;
        let count = 0;
        let unidadLote = 'm¬≤';

        if (locales.length > 0) {
            unidadLote = locales[0].unidad === 'ml' ? 'ml' : 'm¬≤';
        } else if (remotos.length > 0) {
            unidadLote = (remotos[0]['Unidad'] || 'm2') === 'ml' ? 'ml' : 'm¬≤';
        }

        locales.forEach(f => { totalMetros += parseFloat(f.m2) || 0; count++; });
        remotos.forEach(f => { totalMetros += parseFloat(f['M2']) || 0; count++; });
        
        if (loteActual) {
            displayLote.innerHTML = `${loteActual} <br><small>(${count} Fardos - ${totalMetros.toFixed(2)} ${unidadLote})</small>`;
        } else {
            displayLote.innerText = "---";
        }
        
        // 1. Mostrar Fardos Remotos (Base de Datos) - Solo lectura
        remotos.forEach(f => {
            const unidadRemota = (f['Unidad'] || 'm2') === 'ml' ? 'ml' : 'm¬≤';
            const item = document.createElement('div');
            item.className = 'row-item';
            item.style.backgroundColor = '#f8f9fa'; 
            item.style.borderLeft = '4px solid #95a5a6';
            item.innerHTML = `
                <span>‚òÅÔ∏è Fardo: ${f['# Fardo']} (${f['M2']} ${unidadRemota})</span>
                <span style="font-size:0.8rem; color:#666;">${f['Calidad'] || ''}</span>
            `;
            lista.appendChild(item);
        });

        // 2. Mostrar Fardos Locales (Sesi√≥n actual) - Editables
        fardosData.forEach((f, index) => {
            // Solo mostrar si coincide con el lote actual
            if (String(f.lote) !== String(loteActual)) return;

            const totalPiezas = f.detalles.reduce((acc, d) => acc + d.piezas, 0);
            const unidadLocal = f.unidad || 'm2';
            
            const item = document.createElement('div');
            item.className = 'row-item';
            item.innerHTML = `
                <span>Fardo: ${f.fardoNo} (${totalPiezas} pzs - ${f.m2} ${unidadLocal})</span> 
                <div style="display:flex; gap:5px;">
                    <button onclick="imprimir(${index})" class="btn-small" style="width:auto; background:#2c3e50;">Print</button>
                    <button onclick="guardarImagen(${index})" class="btn-small" style="background:#3498db; width:auto;">Img</button>
                    <button onclick="imprimirBluetooth(${index})" class="btn-small" style="background:#e67e22; width:auto;">BT</button>
                    <button onclick="editarFardo(${index})" class="btn-small" style="background:#f1c40f; width:auto; margin-left:5px; color:black;">‚úèÔ∏è</button>
                    <button onclick="eliminarFardo(${index})" class="btn-del" style="width:auto; margin-left:5px;">üóëÔ∏è</button>
                </div>`;
            lista.appendChild(item);
        });
    }

    function eliminarFardo(index) {
        if(confirm("¬øEst√°s seguro de borrar el Fardo #" + fardosData[index].fardoNo + "?")) {
            fardosData.splice(index, 1);
            guardarDatosLocales();
            actualizarLista();
        }
    }

    function editarFardo(index) {
        if(!confirm("¬øEditar este fardo? Se mover√° al formulario para que hagas cambios.")) return;

        const f = fardosData[index];
        
        // Cargar datos en los inputs
        document.getElementById('loteId').value = f.lote;
        document.getElementById('fardoNo').value = f.fardoNo;
        document.getElementById('producto').value = f.producto;
        document.getElementById('grosor').value = f.grosor;
        document.getElementById('ancho').value = f.ancho;
        document.getElementById('especie').value = f.especie;
        
        // Cargar detalles
        currentDetalles = [...f.detalles];
        renderDetalles();

        // Actualizar UI para el producto
        handleProductChange();
        
        // Eliminar de la lista (para que al guardar no se duplique)
        fardosData.splice(index, 1);
        guardarDatosLocales();
        actualizarLista();
        
        // Scroll hacia arriba para editar
        document.querySelector('.container').scrollIntoView({behavior: 'smooth'});
    }

    function prepararEtiqueta(f) {
        // Generar C√≥digo de Barras
        if (typeof JsBarcode !== 'undefined') {
            try {
                JsBarcode("#barcode", f.fardoNo, {
                    format: "CODE128",
                    displayValue: false,
                    height: 40,
                    width: 3,
                    margin: 0
                });
            } catch(e) { console.error(e); }
        }
        
        const unidad = f.unidad === 'ml' ? 'ML' : 'M2';
        document.getElementById('printLote').innerText = "Lote: " + f.lote;
        document.getElementById('printFardoM2').innerText = `Fardo: ${f.fardoNo} - ${f.m2} ${unidad}`;
        
        document.getElementById('printProducto').innerText = `${f.producto} ${f.grosor} x ${f.ancho}"`;
        document.getElementById('printEspecie').innerText = "Especie: " + f.especie;
        
        // Llenar tabla de impresi√≥n
        const colPiezas = document.getElementById('printPiezasCol');
        const colLargos = document.getElementById('printLargosCol');
        
        // Limpiar contenido previo
        colPiezas.innerHTML = "";
        colLargos.innerHTML = "";

        f.detalles.forEach(d => {
            const pDiv = document.createElement('div');
            pDiv.className = 'print-val';
            // pDiv.className = 'print-val'; // Ya no se usa clase, hereda de lbl-td
            pDiv.innerText = d.piezas;
            colPiezas.appendChild(pDiv);

            const lDiv = document.createElement('div');
            lDiv.className = 'print-val';
            lDiv.innerText = `${d.largo}'`;
            // lDiv.className = 'print-val';
            lDiv.innerText = d.largo; // Sin comilla, solo numero
            colLargos.appendChild(lDiv);
        });
    }

    function imprimir(index) {
        const f = fardosData[index];
        prepararEtiqueta(f);
        window.print();
    }

    function guardarImagen(index) {
        const f = fardosData[index];
        prepararEtiqueta(f);
        
        const label = document.getElementById('label-template');
        
        // Mostrar temporalmente para la captura con estilos correctos
        label.style.display = 'flex';
        label.style.position = 'fixed';
        label.style.zIndex = '9999';
        label.style.top = '0';
        label.style.left = '0';
        
        html2canvas(label, { scale: 2 }).then(canvas => {
            label.style.display = 'none'; // Ocultar
            
            canvas.toBlob(function(blob) {
                const file = new File([blob], `Fardo_${f.fardoNo}.png`, { type: "image/png" });

                // Intentar usar el men√∫ nativo de compartir (iPhone/Android)
                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    navigator.share({
                        files: [file]
                    }).catch(e => console.log("Compartir cancelado o fallido", e));
                } else {
                    // Fallback: Descarga directa si no soporta compartir
                    const link = document.createElement('a');
                    link.download = `Fardo_${f.fardoNo}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }
            });
        });
    }

    function exportarExcel() {
        if(fardosData.length === 0) return alert("No hay datos para exportar");
        
        // Aplanar datos para Excel
        let flatData = [];
        fardosData.forEach(f => {
            f.detalles.forEach(d => {
                flatData.push({
                    Lote: f.lote,
                    Fardo: f.fardoNo,
                    Producto: f.producto,
                    Grosor: f.grosor,
                    Especie: f.especie,
                    Piezas: d.piezas,
                    Largo_Ft: d.largo,
                    Ancho_In: f.ancho,
                    Metros: f.m2,
                    Unidad: f.unidad
                });
            });
        });

        const worksheet = XLSX.utils.json_to_sheet(flatData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Inventario");
        
        // Genera el archivo y lo descarga
        XLSX.writeFile(workbook, `Inventario_Lote_${fardosData[0].lote}.xlsx`);
    }

    // --- L√≥gica Bluetooth (Web Bluetooth API) ---
    async function conectarBluetooth() {
        try {
            // Solicitar dispositivo (acepta todos para encontrar la MTH)
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] // Servicio est√°ndar de impresoras
            });
            
            const server = await bluetoothDevice.gatt.connect();
            // Intentamos obtener el servicio de impresi√≥n est√°ndar
            const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
            // Caracter√≠stica de escritura est√°ndar
            printCharacteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
            
            alert("¬°Conectado a " + bluetoothDevice.name + "!");
        } catch (error) {
            console.error(error);
            alert("Error al conectar: " + error + "\n\nAseg√∫rate de usar Bluefy y tener el Bluetooth encendido.");
        }
    }

    async function imprimirBluetooth(index) {
        if (!printCharacteristic) {
            alert("Primero debes conectar la impresora (Bot√≥n Gris arriba)");
            return;
        }

        const f = fardosData[index];
        
        try {
            // Usar la funci√≥n compartida del archivo externo
            await imprimirEtiquetaTerminado(printCharacteristic, f);
        } catch (error) {
            alert("Error enviando datos: " + error);
            conectarBluetooth();
        }
    }
</script>

</body>
</html>