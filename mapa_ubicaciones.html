<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa de Ubicaciones</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #map { height: 100%; width: 100%; background: #f0f0f0; }
        .btn-back {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000; /* Encima del mapa */
            background-color: white;
            color: #2c3e50;
            text-decoration: none;
            padding: 12px 20px;
            border-radius: 15px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border: 1px solid #ddd;
        }
        .btn-refresh {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background-color: #1A237E;
            color: white;
            text-decoration: none;
            padding: 12px 15px;
            border-radius: 15px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #loading-map {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            z-index: 1001;
            font-size: 1.2rem;
            color: #2c3e50;
        }
    </style>
</head>
<body>

    <div id="map"></div>
    <div id="loading-map">üó∫Ô∏è Cargando mapa y ubicaciones...</div>
    <a href="#" onclick="location.reload()" class="btn-refresh">üîÑ Refrescar</a>
    <!-- <a href="base_datos_aserrada.html" class="btn-back">‚¨Ö Volver a la Base de Datos</a> -->

    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";

        window.onload = function() {
            const loadingDiv = document.getElementById('loading-map');
            
            fetch(GOOGLE_SCRIPT_URL + "?sheet=MADERA ASERRADA")
            .then(res => {
                if (!res.ok) throw new Error(`Error de red: ${res.status}`);
                return res.text();
            })
            .then(text => {
                try { return JSON.parse(text); }
                catch (e) { throw new Error("Respuesta inv√°lida del script. Revisa la implementaci√≥n."); }
            })
            .then(data => {
                // Agrupar datos para tener un fardo por marcador
                const agrupado = {};
                data.forEach(row => {
                    const fardo = row['FARDO'];
                    if (!fardo) return;
                    if (!agrupado[fardo]) {
                        agrupado[fardo] = {
                            fardo: fardo,
                            especie: row['ESPECIE'] || '---',
                            calidad: row['CALIDAD'] || '',
                            ubicacion: row['UBICACION'] || ''
                        };
                    }
                });
                const inventario = Object.values(agrupado);

                renderizarMapa(inventario);
            })
            .catch(err => {
                loadingDiv.innerText = `‚ùå Error: ${err.message}`;
                loadingDiv.style.color = 'red';
            });
        };

        function renderizarMapa(inventario) {
            const loadingDiv = document.getElementById('loading-map');
            const map = L.map('map').setView([14.6, -90.5], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(map);

            const markers = L.featureGroup().addTo(map);
            let markersCount = 0;

            inventario.forEach(item => {
                if (item.ubicacion) {
                    const match = String(item.ubicacion).match(/(-?\d+\.\d+),\s*(-?\d+\.\d+)/);
                    if (match) {
                        const marker = L.marker([parseFloat(match[1]), parseFloat(match[2])]);
                        marker.bindPopup(`<b>Fardo #${item.fardo}</b><br>${item.especie}<br>${item.calidad}`);
                        markers.addLayer(marker);
                        markersCount++;
                    }
                }
            });

            if (markersCount > 0) {
                map.fitBounds(markers.getBounds().pad(0.1), { maxZoom: 18 });
                loadingDiv.style.display = 'none';
            } else {
                loadingDiv.innerText = "‚ÑπÔ∏è No se encontraron fardos con coordenadas GPS v√°lidas.";
            }
        }
    </script>

</body>
</html>