<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Etiquetas por Fardo - Meitong BT</title>
    <script src="formato_etiqueta_producto_terminado.js"></script>
    <style>
        :root {
            --primary: #1A237E;
            --bg: #F5F7F9;
            --text-dark: #2c3e50;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
        }
        .container { max-width: 800px; margin: 0 auto; }
        h2 { text-align: center; color: var(--primary); }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            text-align: center;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-search { background-color: var(--primary); color: white; }
        .btn-print-all { background-color: #e67e22; color: white; }
        .btn-bt { background-color: #e0e6ed; color: var(--text-dark); margin-bottom: 15px; }

        .fardo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 5px solid var(--primary);
        }

        #status { text-align: center; font-size: 0.9rem; margin-bottom: 10px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>üè∑Ô∏è Etiquetas de Fardo (Profesional)</h2>
    <button id="btnConnect" class="btn-bt" onclick="conectarBluetooth()">üì° Conectar Impresora BT</button>
    
    <div id="status">Esperando conexi√≥n...</div>

    <div class="card">
        <label>Buscar Lote</label>
        <input type="text" id="loteInput" placeholder="Ej: L-2024-001">
        <button class="btn-search" onclick="buscarLote()">üîç BUSCAR LOTE</button>
    </div>

    <div id="results-area" style="display:none;">
        <button class="btn-print-all" onclick="imprimirTodoElLote()">üñ®Ô∏è IMPRIMIR TODO EL LOTE (BT)</button>
        <div id="fardos-list" style="margin-top:20px;"></div>
    </div>
</div>

<script>
    let bluetoothDevice;
    let printCharacteristic;
    let fardosDelLote = [];

    // Ejemplo de datos con detalles para que la tabla de tu .js funcione
    let inventarioAgrupado = [
        { 
            lote: "L-2024-001", 
            fardoNo: "1", 
            producto: "Pucte S√≥lido", 
            especie: "Pucte", 
            m2: 12.50, 
            ancho: "5", 
            grosor: "1",
            detalles: [
                { piezas: 10, largo: 8 },
                { piezas: 5, largo: 10 }
            ]
        },
        { 
            lote: "L-2024-001", 
            fardoNo: "2", 
            producto: "Manchiche Deck", 
            especie: "Manchiche", 
            m2: 10.20, 
            ancho: "4", 
            grosor: "1",
            detalles: [
                { piezas: 20, largo: 7 }
            ]
        }
    ];

    async function conectarBluetooth() {
        try {
            bluetoothDevice = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb', '0000ff00-0000-1000-8000-00805f9b34fb']
            });

            const server = await bluetoothDevice.gatt.connect();

            let characteristic;
            try {
                const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
            } catch (e) {
                const service = await server.getPrimaryService('0000ff00-0000-1000-8000-00805f9b34fb');
                characteristic = await service.getCharacteristic('0000ff02-0000-1000-8000-00805f9b34fb');
            }
            printCharacteristic = characteristic;
            alert("‚úÖ Conectado a " + bluetoothDevice.name);
        } catch (error) {
            console.log("Cancelado o Error: " + error);
        }
    }

    function buscarLote() {
        const input = document.getElementById('loteInput').value.trim();
        fardosDelLote = inventarioAgrupado.filter(f => f.lote === input);

        if (fardosDelLote.length > 0) {
            renderizarLista();
            document.getElementById('results-area').style.display = 'block';
        } else {
            alert("No se encontr√≥ el lote.");
        }
    }

    function renderizarLista() {
        const container = document.getElementById('fardos-list');
        container.innerHTML = "";
        fardosDelLote.forEach((f, index) => {
            const div = document.createElement('div');
            div.className = 'fardo-item';
            div.innerHTML = `
                <div>
                    <strong>Fardo #${f.fardoNo}</strong><br>
                    <small>${f.producto} - ${f.m2} m¬≤</small>
                </div>
                <button style="width:auto; padding:8px 15px; background:#1A237E; color:white;" 
                        onclick="imprimirIndividual(${index})">Imprimir</button>
            `;
            container.appendChild(div);
        });
    }

    async function imprimirIndividual(index) {
        if (!printCharacteristic) {
            alert("Primero conecta la impresora.");
            return;
        }
        // Llamamos a la funci√≥n de tu archivo externo .js
        try {
            await imprimirEtiquetaTerminado(printCharacteristic, fardosDelLote[index]);
        } catch (e) {
            alert("Error al imprimir: " + e.message);
        }
    }

    async function imprimirTodoElLote() {
        if (!printCharacteristic) return alert("Conecta la impresora.");
        if (!confirm(`¬øImprimir ${fardosDelLote.length} etiquetas?`)) return;
        
        for (const f of fardosDelLote) {
            // Llamamos a la funci√≥n de tu archivo externo en modo silencioso
            await imprimirEtiquetaTerminado(printCharacteristic, f, true);
            await new Promise(r => setTimeout(r, 1000)); // Pausa para estabilidad
        }
        alert("Impresi√≥n de lote completa.");
    }
</script>

</body>
</html>