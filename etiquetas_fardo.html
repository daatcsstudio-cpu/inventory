<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Etiquetas por Fardo</title>
    <script src="formato_etiqueta_producto_terminado.js"></script>
    <style>
        body { font-family: sans-serif; background: #F5F7F9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-search { background: #1A237E; color: white; }
        .btn-bt { background: #e67e22; color: white; margin-bottom: 10px; }
        .fardo-item { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid #1A237E; display: flex; justify-content: space-between; align-items: center; }
        .btn-print { background: #2c3e50; color: white; width: auto; padding: 10px 20px; }
    </style>
</head>
<body>
<div class="container">
    <h2 style="text-align:center; color:#1A237E;">üè∑Ô∏è Reimprimir Etiquetas</h2>
    <button class="btn-bt" onclick="conectarBluetooth()">üì° Conectar Impresora BT</button>
    <div class="card">
        <label>Buscar por Lote</label>
        <input type="text" id="loteInput" placeholder="Ej: L-2024-001">
        <button class="btn-search" onclick="buscarLote()">üîç BUSCAR</button>
    </div>
    <div id="results-area" class="card" style="display:none;"></div>
</div>
<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyJm67IZXi_zHsxQv3mqosqb6-RyKp4-j-h-kqdP153HTN8t6lt7BPE5BrwSzphArkx/exec";
    let inventario = [], fardosDelLote = [], printCharacteristic;

    window.onload = function() {
        fetch(GOOGLE_SCRIPT_URL).then(r=>r.json()).then(d=>inventario=d);
        if(navigator.bluetooth && navigator.bluetooth.getDevices) navigator.bluetooth.getDevices().then(ds=>{if(ds.length) conectarBluetooth(true)});
    };

    function buscarLote() {
        const lote = document.getElementById('loteInput').value.trim();
        const agrupado = {};
        inventario.forEach(r => {
            const l = r['Lote']||r['# Lote'], f = r['Fardo']||r['# Fardo'];
            if(l!=lote) return;
            const k = l+"-"+f;
            if(!agrupado[k]) agrupado[k] = { lote: l, fardoNo: f, producto: r['Producto']||'', especie: r['Especie']||'', grosor: r['Grosor']||'', ancho: r['Ancho']||'', m2: parseFloat(r['M2']||0), detalles: [] };
            if(parseInt(r['Piezas'])>0) agrupado[k].detalles.push({piezas: r['Piezas'], largo: r['Largo']});
        });
        fardosDelLote = Object.values(agrupado).sort((a,b)=>a.fardoNo-b.fardoNo);
        const area = document.getElementById('results-area'); area.style.display = 'block'; area.innerHTML = "";
        fardosDelLote.forEach((f, i) => area.innerHTML += `<div class="fardo-item"><div><b>#${f.fardoNo}</b><br>${f.m2} m¬≤</div><button class="btn-print" onclick="imprimir(${i})">üñ®Ô∏è BT</button></div>`);
    }

    async function conectarBluetooth(silent=false) {
        try {
            let d; if(silent && navigator.bluetooth.getDevices) { const ds = await navigator.bluetooth.getDevices(); if(ds.length) d=ds[0]; }
            if(!d && !silent) d = await navigator.bluetooth.requestDevice({ acceptAllDevices: true, optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb'] });
            if(!d) return;
            const s = await d.gatt.connect(), svc = await s.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
            printCharacteristic = await svc.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
            if(!silent) alert("Conectado");
        } catch(e){ if(!silent) alert(e); }
    }

    async function imprimir(i) {
        if(!printCharacteristic) { await conectarBluetooth(); if(!printCharacteristic) return; }
        try {
            await imprimirEtiquetaTerminado(printCharacteristic, fardosDelLote[i]);
        } catch(e) {
            alert("Error: " + e.message);
        }
    }
</script>
</body>
</html>